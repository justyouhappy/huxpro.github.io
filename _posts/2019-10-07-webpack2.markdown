---
layout:     post
title:      "webpackæºç è§£æï¼ˆ2ï¼‰"
subtitle:   "\" webpackæ„å»ºæ¨¡å—è§£è¯» \""
date:       2019-10-07
author:     "Alan"
header-img: "img/home-bg-geek.jpg"
catalog: true
tags:
    - å‰ç«¯
    - js
    - webpack
---

> live like youself. 


### å‰è¨€

webpackçš„æœ¬è´¨æ˜¯äº‹ä»¶ä¸æ’ä»¶

### ä¸€ã€åˆå§‹åŒ–

#### 1. webpackå…¥å£

é€šè¿‡ä¸Šç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å¯çŸ¥æˆ‘ä»¬é€šè¿‡äº†webpack-cliç»“æŸçš„æ—¶å€™è°ƒç”¨äº†webpack
```
compiler = webpack(options); 
```
çœ‹ä¸‹webpackçš„ä¸»è¦å‡½æ•°
```
const Compiler = require("./Compilerâ€);
const MultiCompiler = require("./MultiCompiler"); 
const NodeEnvironmentPlugin = require("./node/NodeEnvironmentPlugin"); 
const WebpackOptionsApply = require("./WebpackOptionsApply"); 
const WebpackOptionsDefaulter = require("./WebpackOptionsDefaulter"); 
const validateSchema = require("./validateSchema"); 
const WebpackOptionsValidationError = require("./WebpackOptionsValidationError"); 
const webpackOptionsSchema = require("../schemas/WebpackOptions.json"); 
const RemovedPluginError = require("./RemovedPluginError"); 
const version = require("../package.json").version; 
// ...æ¨¡å—å¼•å…¥

function webpack(options, callback) {
    // é”™è¯¯æ£€æµ‹
    const webpackOptionsValidationErrors = validateSchema(webpackOptionsSchema, options);
    if(webpackOptionsValidationErrors.length) {
        throw new WebpackOptionsValidationError(webpackOptionsValidationErrors);
    }
    let compiler;
    // å¤šé…ç½®
    if(Array.isArray(options)) {
        compiler = new MultiCompiler(options.map(options => webpack(options)));
    }
    // å•é…ç½®
    else if(typeof options === "object") { /*...*/ }
    else {
        throw new Error("Invalid argument: options");
    }
    if(callback) { /*...*/ }
    return compiler;
}
exports = module.exports = webpack;

webpack.WebpackOptionsDefaulter = WebpackOptionsDefaulter;
// ...å±æ€§æŒ‚è½½

function exportPlugins( /*...*/ )

exportPlugins( /*...*/ );
exportPlugins( /*...*/ );
```
#### 2. optionsé»˜è®¤å¤„ç†

webpackæ„å»ºç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯è§£ææˆ‘ä»¬ä¼ å…¥çš„optionså¯¹é‡Œé¢çš„é…ç½®é¡¹è¿›è¡ŒåŒ…è£…ï¼ˆå¢åŠ å‡½æ•°å¤„ç†æˆ–é»˜è®¤å€¼ï¼‰ï¼Œå†é‡æ–°è¾“å‡ºã€‚ é¦–å…ˆé€šè¿‡WebpackOptionsDefaulterå®ä¾‹è¿™ä¸ªç±»çš„processè¿™ä¸ªæ–¹æ³•ï¼Œè¿›è¡Œé»˜è®¤é…ç½®å¤„ç†ï¼Œ æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±» 
```
"use strict"; 

const OptionsDefaulter = require("./OptionsDefaulter"); 
const Template = require("./Template"); 

class WebpackOptionsDefaulter extends OptionsDefaulter { 
   constructor() { 
       super(); 
       this.set("entry", "./src"); 
       // å¤§é‡çš„è°ƒç”¨this.set... 
   } 
} 
module.exports = WebpackOptionsDefaulter; 
```
æˆ‘ä»¬å‘ç°å®é™…ä¸ŠWebpackOptionsDefaulteræ˜¯ç»§æ‰¿äº†OptionsDefaulterè¿™ä¸ªç±»ï¼Œå…¶ä¸­å®ä¾‹åŒ–çš„æ—¶å€™è°ƒç”¨çš„this.setå’Œå¤–é¢è°ƒç”¨çš„processéƒ½æ˜¯è°ƒç”¨çš„OptionsDefaulterè¿™ä¸ªç±»é‡Œé¢çš„æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹OptionsDefaulterè¿™ä¸ªç±» ã€‚
```
"use strict";

function getProperty(obj, name) { /**/ }

function setProperty(obj, name, value) { /**/ }

class OptionsDefaulter {
    constructor() {
        this.defaults = {};
        this.config = {};
    }

    process(options) {
        //...
    }

    set(name, config, def) {
        //...
    }
}
module.exports = OptionsDefaulter;
```

åœ¨WebpackOptionsDefaulteråˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰§è¡Œä¸‹é¢çš„å‡½æ•° 

```
set(name, config, def) {
    if (arguments.length === 3) {
        this.defaults[name] = def;
        this.config[name] = config;
    } else {
        this.defaults[name] = config;
        delete this.config[name];
    }
 }
```
å®ƒçš„ä½œç”¨å°±æ˜¯ç»™this.defaultså’Œthis.configèµ‹å€¼, è¿™é‡Œdefaultsä»£è¡¨é»˜è®¤å€¼ï¼Œconfigä»£è¡¨å¯¹optionså‚æ•°çš„å¤„ç†æ–¹æ³•ç±»å‹ï¼Œä¹‹åæ‰§è¡Œprocesså‡½æ•°ï¼Œè¿™é‡Œä¼šæ ¹æ®defaultså’Œå¯¹åº”çš„configçš„å€¼å»å¤„ç†æˆ‘ä»¬çš„optionsï¼Œå°†æœªåœ¨optionsé‡Œé…ç½®çš„é…ç½®èƒ½å–åˆ°å¯¹åº”çš„é…ç½®ï¼Œå…¶ä¸­æ ¹æ®this.defaultså’Œthis.configçš„å€¼å¯¹optionsåšå¯¹åº”çš„å¤„ç† 
```
switch (this.config[name]) { 
    case undefined: 
        if (getProperty(options, name) === undefined) { 
            setProperty(options, name, this.defaults[name]); 
        } 
        break; 
    case "call": 
        setProperty( 
            options, 
            name, 
            this.defaults[name].call(this, getProperty(options, name), options) 
         ); 
        break; 
    case "make": 
        if (getProperty(options, name) === undefined) { 
            setProperty(options, name, this.defaults[name].call(this, options)); 
        } 
        break; 
    case "append": { 
        let oldValue = getProperty(options, name); 
            if (!Array.isArray(oldValue)) { 
                oldValue = []; 
            } 
            oldValue.push(...this.defaults[name]); 
            setProperty(options, name, oldValue); 
        break; 
    } 
    default: 
        throw new Error( 
            "OptionsDefaulter cannot process " + this.config[name] 
        ); 
 } 
```
ä¸Šé¢çš„ä»£ç ä»£è¡¨ä¼šæ ¹æ®configçš„å››ç§å€¼ï¼šundefined call make appendï¼Œä»¥åŠthis.defaultçš„å€¼ï¼Œå¯¹optionsçš„é…ç½®åšå¯¹åº”çš„å¤„ç†ã€‚

1. å¦‚æœå€¼æ˜¯undefined ä»£è¡¨ä¸ç”¨ç‰¹æ®Šå¤„ç†ï¼Œå¦‚æœoptionsä¸­æ²¡æœ‰å¯¹åº”é…ç½®ï¼Œç›´æ¥å°†defalutsé‡Œçš„å€¼èµ‹å€¼ç»™optionsã€‚
2. å¦‚æœå€¼æ˜¯callï¼Œä»£è¡¨optionsé‡Œå¯¹åº”çš„é…ç½®çš„å€¼è¦åœ¨defalutsé‡Œå£°æ˜çš„å‡½æ•°å»å¤„ç†åï¼Œå†å°†ç»“æœèµ‹å€¼ç»™optionså¯¹åº”çš„é…ç½®
3. å¦‚æœå€¼æ˜¯makeï¼Œä»£è¡¨è¿™ä¸ªé…ç½®å¦‚æœæ˜¯å·²ç»åœ¨optionså­˜åœ¨äº†ï¼Œæ˜¯ä¸éœ€è¦ç‰¹æ®Šå¤„ç†çš„ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä¼šæŠŠdefaulté‡Œå£°æ˜çš„å‡½æ•°æ‰§è¡Œï¼Œå¹¶æŠŠoptionsä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œæœ€åå°†æ‰§è¡Œç»“æœèµ‹å€¼ç»™å¯¹åº”optionsçš„é…ç½®ä¸Šã€‚
4. å¦‚æœå€¼æ˜¯appendï¼Œåˆ™ä»£è¡¨æ­¤é…ç½®æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œéœ€è¦å°†defaulté‡Œçš„å€¼èµ‹å€¼ç»™optionsçš„å¯¹åº”çš„é…ç½®é‡Œ

æ­¤æ¨¡å—çš„ä½œç”¨å°±æ˜¯å°†æˆ‘ä»¬æ³¨å…¥çš„optionsåšä¸€äº›é»˜è®¤å¤„ç†ï¼Œæˆ–è€…é»˜è®¤å€¼çš„èµ‹å€¼ã€‚ 


### äºŒã€Compilerç±»

#### 1. æ¦‚å¿µ
Compileræ¨¡å—æ˜¯åšä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿ  å®˜æ–¹å®šä¹‰ 
Compiler æ¨¡å—æ˜¯ webpack çš„æ”¯æŸ±å¼•æ“ï¼Œå®ƒé€šè¿‡ CLI æˆ– Node API ä¼ é€’çš„æ‰€æœ‰é€‰é¡¹ï¼Œåˆ›å»ºå‡ºä¸€ä¸ª compilation å®ä¾‹ã€‚å®ƒæ‰©å±•(extend)è‡ª Tapable ç±»ï¼Œä»¥ä¾¿æ³¨å†Œå’Œè°ƒç”¨æ’ä»¶ã€‚å¤§å¤šæ•°é¢å‘ç”¨æˆ·çš„æ’ä»¶é¦–ï¼Œä¼šå…ˆåœ¨ Compilerä¸Šæ³¨å†Œã€‚

ä¹Ÿå°±æ˜¯ä¸€ä¸ªé’©å­ï¼Œä¸Šé¢æ³¨å†Œäº†é¢å‘ç”¨æˆ·çš„é’©å­ã€‚é€šè¿‡å®ä¾‹åŒ–Compilerç±»å®ä¾‹åŒ–ä¸€ä¸ªcompilerå¯¹è±¡
```
compiler = new Compiler(options.context);
```
Compilerç±»ï¼Œæ˜¯ç»§æ‰¿äº†Tapableçš„ä¸€ä¸ªç±»ï¼Œåœ¨webpack4é‡ŒTapableçš„ç‰ˆæœ¬æ˜¯^1.0.0 
```
const { 
   Tapable, 
   SyncHook, 
   SyncBailHook, 
   AsyncParallelHook, 
   AsyncSeriesHook 
} = require("tapable"); 
class Compiler extends Tapable {...} 
```

Tapableæ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿè¿™å°±æ˜¯æœ¬èŠ‚æˆ‘ä»¬éœ€è¦äº†è§£çš„å†…å®¹ã€‚å®˜æ–¹å®šä¹‰:

Tapable æ˜¯ä¸€ä¸ªå°å‹çš„åº“ï¼Œå…è®¸ä½ å¯¹ä¸€ä¸ª javascript æ¨¡å—æ·»åŠ å’Œåº”ç”¨æ’ä»¶ã€‚å®ƒå¯ä»¥è¢«ç»§æ‰¿æˆ–æ··å…¥åˆ°å…¶ä»–æ¨¡å—ä¸­ã€‚ç±»ä¼¼äº NodeJS çš„ EventEmitter ç±»ï¼Œä¸“æ³¨äºè‡ªå®šä¹‰äº‹ä»¶çš„è§¦å‘å’Œå¤„ç†ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒTapable è¿˜å…è®¸ä½ é€šè¿‡å›è°ƒå‡½æ•°çš„å‚æ•°ï¼Œè®¿é—®äº‹ä»¶çš„â€œè§¦å‘è€…(emittee)â€æˆ–â€œæä¾›è€…(producer)â€ã€‚

ä¸‹é¢æ˜¯Tapableé‡Œå„ç§è‡ªå®šä¹‰äº‹ä»¶çš„åç§°ä»¥åŠè¦ç‚¹ã€‚
![tapable](/img/tapable.png)

webpacké€šè¿‡ç»§æ‰¿äºTapableçš„Compilerå£°æ˜äº†å„ç§äº‹ä»¶é’©å­ï¼Œå»å¤„ç†é…ç½®é¡¹å£°æ˜å¥½çš„ç¼–è¯‘ã€‚compilerå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªäº‹ä»¶æµç”¨æ¥ç®¡ç†webpackç¼–è¯‘çš„æ¯ä¸€æ­¥ã€‚

æˆ‘ä»¬å†™webpackæ’ä»¶çš„å›ºå®šæ ¼å¼å®é™…ä¸Šä¹Ÿæ˜¯ä¾èµ–äºæ­¤æ¨¡å—çš„apiçš„ï¼Œä¸¾ä¸ªğŸŒ°ï¼š[ç¼–å†™æ’ä»¶](https://webpack.docschina.org/contribute/writing-a-plugin/)

#### 2. NodeEnvironmentPluginï¼šè¾“å…¥è¾“å‡º 

Compiler å®ä¾‹åœ¨ä¸€å¼€å§‹ä¹Ÿä¼šåˆå§‹åŒ–è¾“å…¥è¾“å‡ºï¼Œåˆ†åˆ«æ˜¯ inputFileSystem å’Œ outputFileSystem å±æ€§ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå±æ€§éƒ½æ˜¯å¯¹åº”çš„ nodejs ä¸­æ‹“å±•åçš„ fs å¯¹è±¡ã€‚ä½†æ˜¯æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œå½“ Compiler å®ä¾‹ä»¥ watch æ¨¡å¼è¿è¡Œæ—¶ï¼Œ outputFileSystem ä¼šè¢«é‡å†™æˆå†…å­˜è¾“å‡ºå¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®é™…ä¸Šåœ¨ watch æ¨¡å¼ä¸‹ï¼Œwebpack æ„å»ºåçš„æ–‡ä»¶å¹¶ä¸ä¼šç”ŸæˆçœŸæ­£çš„æ–‡ä»¶ï¼Œè€Œæ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚
å…¶ä¸­inputFileSystemæ˜¯é€šè¿‡enhanced-resolve/lib/CachedInputFileSystemåšäº†ä¸€ä¸ªç¼“å­˜æœºåˆ¶ã€‚
åœ¨NodeEnvironmentPluginé‡Œï¼ŒåŸ‹ä¸‹äº†ä¸€ä¸ªäº‹ä»¶æµèŠ‚ç‚¹ï¼Œä½œç”¨æ˜¯åœ¨çœŸæ­£runä¹‹å‰æ¸…é™¤æ‰€æœ‰å¯¹æ–‡ä»¶çš„ç¼“å­˜ã€‚
```
compiler.hooks.beforeRun.tap("NodeEnvironmentPlugin", compiler => {
    if (compiler.inputFileSystem === inputFileSystem) inputFileSystem.purge();
});
```
#### 3. Optionså±æ€§

å½“webpackå¼€å§‹è¿è¡Œæ˜¯ï¼Œç¬¬ä¸€ä»¶äº‹å°±æ˜¯è§£ææˆ‘ä»¬åˆå§‹åŒ–åçš„optionsï¼Œç„¶åæŒ‚è½½åˆ°Compilerä¸Šã€‚å¦‚æœè¯´WebpackOptionsApply.process è¿™ä¸ªæ–¹æ³•å°†ä¼šé’ˆå¯¹æˆ‘ä»¬ä¼ è¿›å»çš„webpack ç¼–è¯‘å¯¹è±¡è¿›è¡Œé€ä¸€ç¼–è¯‘ï¼Œæ­¤å‡½æ•°çš„ä½œç”¨å°±æ˜¯å°†optionsæ¿€æ´»å¹¶æŒ‚è½½åˆ°Compilerï¼Œç­‰å¾…ç¼–è¯‘è°ƒç”¨ã€‚ï¼ˆè¿™é‡Œæœ‰ç„æœºï¼Œä¹°ä¸ªå…³å­ï¼‰
```
compiler = new Compiler();
// å…¶ä»–ä»£ç ..
compiler.options = new WebpackOptionsApply().process(options, compiler);
```
å½“compileråˆå§‹åŒ–ç»“æŸä¹‹åï¼Œæˆ‘ä»¬å°±ä¼šå›åˆ°webpack-cliçš„é€»è¾‘
#### 4. Compiler.run

å›åˆ°webpack-clié€»è¾‘æˆ‘ä»¬å¯ä»¥çœ‹è§æœ‰äº›å‘½ä»¤ï¼Œåœ¨compileråˆå§‹åŒ–ä¹‹åæ‰ä¼šæ‰§è¡Œï¼Œæ¯”å¦‚æ‰“å°ç™¾åˆ†æ¯”çš„å‘½ä»¤--progressï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆå†™å‘¢ï¼ŸåŸå› å…¶å®å¾ˆç®€å•ï¼Œè¿™äº›æ’ä»¶æ˜¯åœ¨compilerç¼–è¯‘çš„äº‹ä»¶æµä¸­æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦åœ¨compileråˆå§‹åŒ–ä¹‹åæ‰å¯ä»¥æŒ‚è½½æ’ä»¶åˆ°complierä¸Šï¼Œcomplieræ˜¯æˆ‘ä»¬æ‰€æœ‰è‡ªå®šä¹‰æ’ä»¶çš„æŒ‚è½½çš„ç›®æ ‡ã€‚

```
if (argv.progress) {
    const ProgressPlugin = require("webpack").ProgressPlugin;
    new ProgressPlugin({
        profile: argv.profile
    }).apply(compiler);
}

if (outputOptions.infoVerbosity === "verbose") {
    compiler.hooks.beforeCompile.tap("WebpackInfo", compilation => {
        console.log("\nCompilation startingâ€¦\n");
    });
    compiler.hooks.afterCompile.tap("WebpackInfo", compilation => {
        console.log("\nCompilation finished\n");
    });
}
```
æ¥ä¸‹æ¥æœ‰å°±ä¼šæœ‰ä¸¤ä¸ªåˆ†æ”¯äº†ï¼Œä¸€ç§æ˜¯watchï¼Œä¸€ç§æ˜¯runï¼Œæ—¢ç„¶æ˜¯å¸Œæœ›äº†è§£æ‰“åŒ…æµç¨‹æˆ‘ä»¬ç›´æ¥çœ‹runçš„é€»è¾‘äº†

é‡ç‚¹æ¥äº†

æˆ‘ä»¬è°ƒç”¨äº†Comiler.run()ï¼Œå¯ä»¥çœ‹ä¸‹ï¼Œæˆ‘ä»¬é¦–å…ˆè§¦å‘äº†beforeRunè¿™ä¸ªasyncé’©å­ï¼Œåœ¨è¿™ä¸ªé’©å­ä¸­ç»‘å®šäº†è¯»å–æ–‡ä»¶çš„å¯¹è±¡ï¼Œä¹Ÿä¼šè§¦å‘ä¸Šé¢è¯´çš„æ¸…é™¤æ–‡ä»¶ç¼“å­˜çš„é€»è¾‘ã€‚æ¥ç€æ˜¯runè¿™ä¸ªasyncé’©å­ï¼Œåœ¨è¿™ä¸ªé’©å­ä¸­é€šè¿‡readRecordsè¿™ä¸ªå‡½æ•°ï¼Œå»å¤„ç†ç¼“å­˜çš„æ¨¡å—ï¼Œå‡å°‘ç¼–è¯‘çš„æ¨¡å—ï¼ŒåŠ é€Ÿç¼–è¯‘é€Ÿåº¦ï¼ˆé€šè¿‡ä¸Šé¢è¯´çš„è¾“å…¥è¾“å‡ºæ¨¡å—ï¼Œrunçš„æ—¶å€™ä¸ä¼šè§¦å‘ï¼‰ã€‚ä¹‹åæ‰ä¼šè¿›å»å…¥Compiler.compile()çš„ç¼–è¯‘ç¯èŠ‚ã€‚
```
run(callback) {
        // åˆ¤æ–­æ˜¯å¦å·²ç»åœ¨æ‰“åŒ…ä¸­ï¼Œå¦‚æœé‡å¤æ‰§è¡ŒæŠ¥é”™
        if (this.running) return callback(new ConcurrentCompilationError());
        // åˆå§‹åŒ–ä¸€äº›å˜é‡.....
        this.hooks.beforeRun.callAsync(this, err => {
            // å¦‚æœç»‘å®šåœ¨beforeRunäº‹ä»¶çš„æ’ä»¶æ‰§è¡Œé”™è¯¯ï¼Œä¼šæŠ¥é”™
            if (err) return finalCallback(err);
            this.hooks.run.callAsync(this, err => {
                // å¦‚æœç»‘å®šåœ¨runäº‹ä»¶çš„æ’ä»¶æ‰§è¡Œé”™è¯¯ï¼Œä¼šæŠ¥é”™
                if (err) return finalCallback(err);
                this.readRecords(err => {
                    if (err) return finalCallback(err);
                    this.compile(onCompiled);
                });
            });
        });
}
```
ç­‰Compiler.compileè¿è¡Œç»“æŸä¹‹åä¼šå›è°ƒrunä¸­åä¸ºonCompiledçš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯å°†ç¼–è¯‘åçš„å†…å®¹ç”Ÿæˆæ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é¦–å…ˆæ˜¯shouldEmitåˆ¤æ–­æ˜¯å¦ç¼–è¯‘æˆåŠŸï¼ŒæœªæˆåŠŸåˆ™ç»“æŸdoneï¼Œæ‰“å°ç›¸åº”ä¿¡æ¯ã€‚æˆåŠŸåˆ™è°ƒç”¨this.emitAssetsæ‰“åŒ…æ–‡ä»¶ã€‚
```
const onCompiled = (err, compilation) => {
    if (err) return finalCallback(err);
    if (this.hooks.shouldEmit.call(compilation) === false) {
        const stats = new Stats(compilation);
        stats.startTime = startTime;
        stats.endTime = Date.now();
        this.hooks.done.callAsync(stats, err => {
            if (err) return finalCallback(err);
            return finalCallback(null, stats);
        });
        return;
    }
    this.emitAssets(compilation, err => {
        if (err) return finalCallback(err);
        if (compilation.hooks.needAdditionalPass.call()) {
            compilation.needAdditionalPass = true;
            const stats = new Stats(compilation);
            stats.startTime = startTime;
            stats.endTime = Date.now();
            this.hooks.done.callAsync(stats, err => {
                if (err) return finalCallback(err);
                this.hooks.additionalPass.callAsync(err => {
                    if (err) return finalCallback(err);
                    this.compile(onCompiled);
                });
            });
            return;
        }
        this.emitRecords(err => {
            if (err) return finalCallback(err);
            const stats = new Stats(compilation);
            stats.startTime = startTime;
            stats.endTime = Date.now();
            this.hooks.done.callAsync(stats, err => {
                if (err) return finalCallback(err);
                return finalCallback(null, stats);
            });
        });
    });
};
```
#### 5. Compiler.compile

compilerå°±æ˜¯ç¼–è¯‘çš„æ„æ€ã€‚é‚£ä¹ˆç¼–è¯‘çš„è¿‡ç¨‹ä¸­ç©¶ç«Ÿå‘ç”Ÿäº†å†™ä»€ä¹ˆå‘¢ï¼Ÿ
```
const params = this.newCompilationParams();
this.hooks.beforeCompile.callAsync(params, err => {
    ...
        this.hooks.compile.call(params);
        const compilation = this.newCompilation(params);
        this.hooks.make.callAsync(compilation, err => {
                ...
                compilation.finish();
                compilation.seal(err => {
                    ...        
                    this.hooks.afterCompile.callAsync(compilation, err => {
                        ...
                        //æ­¤å¤„æ˜¯å›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨äºå°†ç¼–è¯‘æˆåŠŸçš„ä»£ç è¾“å‡º
                        });
                });
        });
});
```
é¦–å…ˆæ˜¯å®šä¹‰äº†paramså¹¶ä¼ å…¥äº†hooks.compileè¿™ä¸ªé’©å­ä¸­ï¼Œparamså°±æ˜¯æ¨¡å—å·¥å‚,è¿™é‡Œåˆ°è°ƒç”¨æ—¶ç»§ç»­çœ‹
ç„¶åæ˜¯beforeCompileé¢„å¤‡ä¸€ä¸‹ï¼ˆå…¶ä¸­ä¼šæ‰§è¡Œæˆ‘ä»¬è‡ªå®šä¹‰æˆ–è€…å¼•å…¥åœ¨ç¼–è¯‘æ‰§è¡Œä¹‹å‰çš„æ’ä»¶ï¼‰ï¼Œæ¥ç€å°±æ˜¯å¯åŠ¨compileè¿™ä¸ªé’©å­ã€‚
è¿™é‡Œæ–°å»ºäº†Compilationï¼Œä¸€ä¸ªå¾ˆé‡è¦çš„ä¸“æ³¨äºç¼–è¯‘çš„ç±»ã€‚
hooks.makeè¿™ä¸ªé’©å­å°±æ˜¯æ­£å¼å¯åŠ¨ç¼–è¯‘äº†ï¼ˆç»ˆäºåˆ°ç¼–è¯‘äº†ï¼‰è¿™é‡Œæ‰§è¡Œç»“æŸå°±ä»£è¡¨å¤§éƒ¨åˆ†çš„å·¥ä½œå·²ç»ç»“æŸäº†ï¼Œé‚£å®ƒå…·ä½“å¹²äº†ä»€ä¹ˆå‘¢ï¼Ÿ
åˆ°è¿™é‡Œæˆ‘å¾ˆå›°æƒ‘ï¼Œä»–æ˜¯æ€ä¹ˆå¼€å§‹çš„å‘¢ï¼Ÿè‚¯å®šæ˜¯å‰é¢çš„æŸäº›ç»†èŠ‚æ²¡æœ‰æ³¨æ„ï¼ŒåºŸäº†ä¹ç‰›äºŒè™ä¹‹åŠ›ï¼Œç»ˆäºæ‰¾åˆ°äº†hooks.makeçš„callAsyncï¼ˆcallAsyncä½œç”¨æ˜¯ä¾æ¬¡è§¦å‘makeçš„é’©å­æ³¨å†Œçš„äº‹ä»¶ï¼Œå†™æ’ä»¶çš„æ—¶å€™åªèƒ½æ³¨å†Œä¸èƒ½æå‰è§¦å‘å“¦ï¼Œä¼šå½±å“æ•´ä¸ªæ„å»ºçš„ç”Ÿå‘½å‘¨æœŸçš„ï¼‰ä¾æ¬¡è§¦å‘äº†ä»€ä¹ˆã€‚

å®ƒè§¦å‘äº†singleEntryPluginï¼ˆå•å…¥å£æ–‡ä»¶çš„å¤„ç†ï¼Œå¦‚æœå¤šå…¥å£è§¦å‘çš„å°±æ˜¯MultiEntryPluginï¼‰é‡Œæ³¨å†Œçš„äº‹ä»¶ã€‚

```
compiler.hooks.make.tapAsync(
    "SingleEntryPlugin",
    (compilation, callback) => {
        const { entry, name, context } = this;
        const dep = SingleEntryPlugin.createDependency(entry, name);
        compilation.addEntry(context, dep, name, callback);
     }
);
```
è€Œè¿™ä¸ªäº‹æƒ…æ˜¯ä»€ä¹ˆæ—¶æœºåšçš„å‘¢ï¼Ÿå°±æ˜¯åœ¨è¿™é‡Œ ==ã€‹ WebpackOptionsApplyçš„294è¡Œï¼ˆå¡«å‘å®Œæ¯•ï¼‰EntryOptionPluginæ˜¯å¤„ç†å…¥å£ç±»å‹çš„æ’ä»¶ï¼Œä»–ä¼šwebpack.config.jsä¸­entryçš„ä¸åŒé…ç½®å¸®åŠ©æˆ‘ä»¬æ­é…ä¸åŒçš„EntryPluginã€‚
é€šè¿‡entryé…ç½®è¿›å…¥çš„ä¸€å…±æœ‰3ç§ç±»å‹ï¼ŒSingleEntryPluginï¼ŒMultiEntryPluginå’ŒDynamicEntryPluginï¼Œæ ¹æ®åå­—å°±èƒ½å¤Ÿè½»æ˜“åŒºåˆ†ä»–ä»¬çš„ç±»å‹ã€‚ä¸€èˆ¬ä¸€ä¸ªcompileråªä¼šè§¦å‘ä¸€ä¸ªEntryPluginï¼Œç„¶ååœ¨è¿™ä¸ªEntryPluginä¸­ï¼Œä¼šæœ‰æˆ‘ä»¬æ„å»ºæ¨¡å—çš„å…¥å£ï¼Œä¹Ÿå°±æ˜¯compilationçš„å…¥å£ã€‚
```
new EntryOptionPlugin().apply(compiler);
compiler.hooks.entryOption.call(options.context, options.entry);
```
å€¼å¾—æ³¨æ„çš„æ˜¯EntryOptionPluginè¿˜å¸®æˆ‘ä»¬å®šä¹‰äº†compilationçš„å·¥ç¨‹å‚ç±»å‹(è¿™é‡Œè§¦å‘åœ¨Complierçš„newCompilationé‡Œ)
```
compiler.hooks.compilation.tap(
            "SingleEntryPlugin",
            (compilation, { normalModuleFactory }) => {
                compilation.dependencyFactories.set(
                    SingleEntryDependency,
                    normalModuleFactory
                );
            }
);
```
è¿™é‡Œæˆ‘ä»¬æ¥å¼ å›¾ç‰‡çœ‹ä¸‹webpackä¹‹é—´é”™ç»¼å¤æ‚çš„æƒ…æ„Ÿå¤§æˆå…³è”
![link](/img/link.png)


è¿™é‡Œå¤§æ¦‚å¯ä»¥å¾—çŸ¥webpackçš„æ¨¡å—æ„å»ºå…¶å®æ˜¯é€šè¿‡entryï¼ˆconfigé‡Œé…ç½®çš„é‚£ä¸ªï¼‰ï¼Œä¹Ÿå°±æ˜¯å…¥å£æ–‡ä»¶å¼€å§‹åˆ†æï¼Œå¼€å§‹æ„å»ºã€‚ä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªå…¥å£æ–‡ä»¶ä¼šè§¦å‘ä¸€æ¬¡Compliation.addEntryï¼Œç„¶åè§¦å‘ä¹‹åå°±æ˜¯Compilationå¼€å§‹æ„å»ºæ¨¡å—äº†ã€‚
```
compiler.hooks.make.tapAsync(
            "SingleEntryPlugin",
            (compilation, callback) => {
                const { entry, name, context } = this;
                console.log(entry, name, context)
                const dep = SingleEntryPlugin.createDependency(entry, name);
                compilation.addEntry(context, dep, name, callback);
            }
);
```
#### 6. ç¼–è¯‘æµç¨‹Compilation
Compilationæ˜¯è¿™ä¹ˆä¸ªä¸œè¥¿....
![Compilation](/img/Compilation.png)
          
é¦–å…ˆçœ‹ä¸‹addEntry
```
addEntry(context, entry, name, callback) {
        // .....
        this._addModuleChain(
            context,
            entry,
            module => {
                this.entries.push(module);
            },
            (err, module) => {
                if (err) {
                    return callback(err);
                }

                if (module) {
                    slot.module = module;
                } else {
                    const idx = this._preparedEntrypoints.indexOf(slot);
                    if (idx >= 0) {
                        this._preparedEntrypoints.splice(idx, 1);
                    }
                }
                return callback(null, module);
            }
        );
    }
```
æ·»åŠ æ¨¡å—çš„ä¾èµ–_addModuleChainï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¸€æ˜¯æ ¹æ®æ¨¡å—çš„ç±»å‹è·å–å¯¹åº”çš„æ¨¡å—å·¥å‚å¹¶åˆ›å»ºæ¨¡å—ï¼ŒäºŒæ˜¯æ„å»ºæ¨¡å—ã€‚
```
const moduleFactory = this.dependencyFactories.get(Dep); 
// è¿™å¥è¯å°±æ‹¿åˆ°äº†æˆ‘ä»¬ä¹‹å‰é€‰æ‹©çš„å·¥ç¨‹æ¨¡å— ==ã€‹normalModuleFactory 
// dependencyFactoriesåŒ…å«äº†æ‰€æœ‰çš„ä¾èµ–é›†åˆ
```

æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨moduleFactory.createï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯è°ƒç”¨å·¥å‚çš„æ–¹æ³•ç”Ÿäº§æ¨¡å—ï¼Œè¿™é‡Œçš„æµç¨‹å°±æ˜¯æ„å»ºè¯­æ³•æ ‘çš„è¿‡ç¨‹ï¼ŒåŒæ—¶è°ƒç”¨äº†buildModuleçš„é’©å­ï¼ˆæˆ‘ä»¬çš„æ’ä»¶ç”¨çš„ï¼‰ï¼ˆè¿™é‡Œå…ˆä¸å¤šè¯´ï¼‰ã€‚

å•ç‹¬çœ‹createå¹²äº†ä»€ä¹ˆå‘¢ï¼Ÿ

- è§¦å‘ beforeResolve äº‹ä»¶ï¼šè¿™é‡Œ beforeResolve äº‹ä»¶ä¸­æ²¡æœ‰åšä»»åŠ¡å¤„ç†ï¼Œç›´æ¥è¿›å…¥å›è°ƒå‡½æ•°
- è§¦å‘ NormalModuleFactory ä¸­çš„ factory äº‹ä»¶ã€‚åœ¨ NormalModuleFactory çš„ constructor ä¸­æœ‰ä¸€æ®µæ³¨å†Œ factory äº‹ä»¶çš„é€»è¾‘ã€‚
- æ‰§è¡Œ factory æ–¹æ³•ï¼ˆå…·ä½“ä»£ç ä½äº NormalModuleFactory çš„ constructor ä¸­ï¼‰ï¼Œä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š      
![NormalModuleFactory](/img/NormalModuleFactory.png)

1.resolver é˜¶æ®µï¼šå¾—åˆ°è·¯å¾„ä¿¡æ¯ä»¥åŠæ¶‰åŠåˆ°çš„ loader å’Œ loader çš„è·¯å¾„ã€‚è¿™ä¸€æ­¥å®Œæˆåï¼Œç”Ÿæˆ module çš„å‡†å¤‡å·¥ä½œå·²ç»å®Œæˆã€‚

```
this.hooks.resolver.tap("NormalModuleFactory", () => (data, callback) => {
    //data æ˜¯ä¸Šé¢createä¼ å…¥çš„
    //...
    const loaderResolver = this.getResolver("loader");
    const normalResolver = this.getResolver("normal", data.resolveOptions);
}
```
2.resolveræ‰§è¡Œç»“æŸåï¼Œä¼šå¾—åˆ°ä¸€ä¸ªdata,  dependencieså°±æ˜¯ä¾èµ–è¿›å…¥createModule é˜¶æ®µï¼šç”Ÿæˆä¸€ä¸ª module å®ä¾‹ï¼Œå°†ä¸Šä¸€æ­¥çš„æ•°æ®å­˜å…¥å®ä¾‹ä¸­ã€‚

```
// data
[ CommonJsRequireDependency {
    module: null,
    weak: false,
    optional: false,
    loc: SourceLocation { start: [Position], end: [Position] },
    request: './../webpack/buildin/module.js',
    userRequest: 'module',
    range: [ 8, 40 ] } ]

resolver(result, (err, data) => {
    if (err) return callback(err);
    // Ignored
    this.hooks.afterResolve.callAsync(data, (err, result) => {
        if (err) return callback(err);

        // Ignored
        if (!result) return callback();
        let createdModule = this.hooks.createModule.call(result);
        if (!createdModule) {
            if (!result.request) {
                return callback(new Error("Empty dependency (no request)"));
            }

            createdModule = new NormalModule(result);
        }

        createdModule = this.hooks.module.call(createdModule, result);

        return callback(null, createdModule);
    });
});
```

3.æ„å»ºç»“æŸé˜¶æ®µ è°ƒç”¨äº†Compilation.finish

è¿™é‡Œfinishå¹²äº†å‡ ä»¶äº‹ï¼Œä¸€ä»¶å°±æ˜¯å‡ºå‘äº†ç»“æŸæ„å»ºçš„é’©å­ï¼Œç„¶åå°±æ˜¯æ”¶é›†äº†æ¯ä¸ªæ¨¡å—æ„å»ºæ—¶äº§ç”Ÿçš„é—®é¢˜ï¼Œæœ€åå°±æ˜¯é€šè¿‡templatæ¨¡æ¿ï¼Œé‡æ–°èšåˆåˆ°ä¸€å—ï¼Œç„¶åå›è°ƒcomplierçš„æ¨¡å—ç”Ÿæˆæ–‡ä»¶ï¼ˆå°±æ˜¯ä¸Šé¢è¯´çš„ä¼˜åŒ–åçš„è¾“å…¥è¾“å‡ºæ–‡ä»¶çš„é‚£ä¸ªï¼æœ‰ç”¨äº†ï¼ï¼ï¼‰ã€‚
ä¹‹åè°ƒç”¨seal,è¾“å‡ºæ–‡ä»¶ï¼Œè¿™é‡Œåšäº†å¾ˆå¤šä¼˜åŒ–çš„hookï¼ˆä¸€å †æ’ä»¶ï¼Œå¤ªå¤šäº†ï¼Œä¸çœ‹äº†ğŸ™ˆï¼‰æœç„¶webpackå°±æ˜¯äº‹ä»¶æµå’Œæ’ä»¶çš„èšåˆï¼

4.æ¨¡å—å·¥å‚â€”moduleFactory

å—¯ï¼Œæ²¡é”™åˆè¦è·³å›åˆ°compilerï¼Œè¿˜è®°å¾—beforeCompileé‡Œçš„parmså—ï¼Ÿæ²¡é”™å°±æ˜¯newCompilationParamsé‡Œçš„ï¼Œå®é™…ä¸Šæˆ‘ä»¬æœ‰ä¸‰ç§ç±»å‹ï¼Œemmmï¼Œæˆ‘åªçœ‹äº†normalç±»å‹çš„ï¼ˆå¯ä»¥è‡ªå·±äº†è§£ä¸‹å…¶ä»–çš„ï¼Œç„¶åç»™æˆ‘è®²è®²å¯å¥½ğŸ˜­ï¼‰

              
            
ä»–æ˜¯å¹²å•¥çš„ï¼Ÿ

å°±æ˜¯æ„å»ºæ¨¡å—çš„ï¼å·¥å‚ç±»é‡Œæœ‰æœ‰ä¸¤ä¸ªå‚æ•°å¾ˆé‡è¦ä¸€ä¸ªæ˜¯é€šè¿‡NormalModuleåˆ›å»ºçš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯æ¨¡å—ï¼Œè¿˜æœ‰å°±æ˜¯RuleSetï¼Œå®ƒå°±æ˜¯loadersï¼Œå…¶ä¸­åŒ…æ‹¬è‡ªå¸¦çš„loaderå’Œè‡ªå®šä¹‰çš„loaderã€‚

ä¹Ÿå°±æ˜¯è¯´Factoryå¹²äº†ä¸¤ä»¶äº‹ï¼Œç¬¬ä¸€ä»¶æ˜¯åŒ¹é…äº†ç›¸å¯¹åº”çš„parserï¼Œå°†parseré…ç½®æˆäº†ä¸“é—¨ç”¨äºå½“å‰æ¨¡å—çš„è§£æå™¨å°†æºç è§£ææˆASTæ¨¡å¼ï¼Œç¬¬äºŒä»¶æ˜¯åˆ›å»ºgeneratorç”¨äºç”Ÿæˆä»£ç ä¹Ÿå°±æ˜¯è¿˜åŸASTï¼ˆè¿™ä¸€å—æ˜¯æ¨¡ç‰ˆç”Ÿæˆçš„æ—¶å€™ä¼šç”¨åˆ°ï¼‰ï¼Œç¬¬ä¸‰ä»¶æ˜¯åˆ›å»ºæ¨¡å—ï¼Œæ„å»ºæ¨¡å—çš„æ—¶å€™ç»™ä»–æ‰¾åˆ°ç›¸æ˜ çš„loaderï¼Œæ›¿æ¢æºç ï¼Œæ·»åŠ ç›¸æ˜ çš„ä¾èµ–æ¨¡å—ï¼Œç„¶ååœ¨æ¨¡å—è§£æçš„æ—¶å€™æä¾›ç›¸åº”çš„parserè§£æå™¨ï¼Œåœ¨ç”Ÿæˆæ¨¡ç‰ˆçš„æ—¶å€™æä¾›ç›¸åº”çš„generatorã€‚

5.normalModuleç±»

Fatoryæä¾›äº†åŸæ–™ï¼ˆoptionsï¼‰å’Œå·¥å…·ï¼ˆparserï¼‰ï¼Œå°±ç­‰äºå°†å‚æ•°è¾“ç»™äº†è‡ªåŠ¨åŒ–çš„æœºå™¨ï¼Œè¿™ä¸ªnormalModuleå°±æ˜¯åˆ›é€ çš„æœºå™¨ï¼Œç”±ä»–æ¥buildæ¨¡å—ï¼Œå¹¶å°†æºç å˜ä¸ºASTè¯­æ³•æ ‘ã€‚

```
build(options, compilation, resolver, fs, callback) {
    //...
        return this.doBuild(options, compilation, resolver, fs, err => {
            //...
                this._cachedSources.clear();
                //...
                try {
                        const result = this.parser.parse(//é‡ç‚¹åœ¨è¿™é‡Œã€‚
                                //....
                        );
                    //...

        });
}
```

åœ¨Compilationä¸­æ¨¡å—åˆ›å»ºå¥½ä¹‹åï¼Œå¼€å§‹è§¦å‘moduleçš„buildæ–¹æ³•ï¼Œå¼€å§‹ç”Ÿæˆæ¨¡å—ï¼Œä»–çš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯è¾“å…¥sourceæºæ–‡ä»¶ï¼Œç„¶åé€šè¿‡resloverè§£ææ–‡ä»¶loaderå’Œä¾èµ–çš„æ–‡ä»¶ï¼Œå¹¶è¿”å›ç»“æœã€‚ç„¶åé€šè¿‡loaderå°†æ­¤è½¬åŒ–ä¸ºæ ‡å‡†çš„webpackæ¨¡å—ï¼Œå­˜å‚¨sourceï¼Œç­‰å¾…ç”Ÿæˆæ¨¡ç‰ˆçš„æ—¶å€™å¤‡ç”¨ã€‚
ç­‰åˆ°éœ€è¦æ‰“åŒ…çš„æ—¶å€™ï¼Œå°±å°†ç¼–è¯‘è¿‡çš„æºç åœ¨é‡ç»„æˆJSä»£ç ï¼Œä¸»è¦é€šè¿‡Facotryç»™æ¨¡å—é…å¤‡çš„generatorã€‚

6.loaderå’Œpluginçš„åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢

åŒºåˆ«1: pluginå¯ä»¥åœ¨ä»»ä½•ä¸€ä¸ªæµç¨‹èŠ‚ç‚¹å‡ºç°ï¼Œloaderæœ‰ç‰¹å®šçš„æ´»åŠ¨èŒƒå›´
åŒºåˆ«2: pluginå¯ä»¥åšå’Œæºç æ— å…³çš„äº‹ï¼Œæ¯”å¦‚ç›‘æ§ï¼Œloaderåªèƒ½è§£ææºç å˜æˆæ ‡å‡†æ¨¡å—ã€‚

é‚£loaderæ˜¯æ€ä¹ˆè¿›å…¥moduleçš„å‘¢ï¼Ÿ

é¦–å…ˆæ˜¯Compilation._addModuleChainå¼€å§‹æ·»åŠ æ¨¡å—æ—¶

```
// createdModuleé˜¶æ®µä¹‹åä¼šå›åˆ°moduleFactory.createçš„callbacké‡Œ
const addModuleResult = this.addModule(module);
// addModule ä¼šæ‰§è¡Œ this._modules.set(identifier, module);å’Œ this.modules.push(module);
//å…¶ä¸­ identifier å¯¹äº normalModule æ¥è¯´å°±æ˜¯ module.requestï¼Œå³æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
// å¯¹äºå…¥å£æ–‡ä»¶æ¥è¯´ï¼Œè¿™é‡Œä¼šæ‰§è¡Œ this.entries.push(module);
 onModule(module);
//....
if (addModuleResult.build) {
    this.buildModule(module, false, null, null, err => {
        if (err) {
            this.semaphore.release();
            return errorAndCallback(err);
        }

        if (currentProfile) {
            const afterBuilding = Date.now();
            currentProfile.building = afterBuilding - afterFactory;
        }

        this.semaphore.release();
        afterBuild();
    });
} 
```

è¿™ä¸ªé˜¶æ®µå¯ä»¥è®¤ä¸ºæ˜¯ add é˜¶æ®µï¼Œå°† module çš„æ‰€æœ‰ä¿¡æ¯ä¿å­˜åˆ° Compilation ä¸­ï¼Œä»¥ä¾¿äºåœ¨æœ€åæ‰“åŒ…æˆ chunk çš„æ—¶å€™ä½¿ç”¨ã€‚éšååœ¨è¿™ä¸ªå›è°ƒå‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨ this.buildModule è¿›å…¥ build é˜¶æ®µã€‚

this.buildModuleè¿™ä¸ªæ–¹æ³•ï¼Œç„¶åè°ƒç”¨äº†NormalModule.buildï¼Œå¼€å§‹åˆ›å»ºæ¨¡å—äº†ã€‚

7.NormalModule.build æ–¹æ³•ã€‚build æ–¹æ³•ä¸»é€»è¾‘å¦‚ä¸‹ï¼š
```
// NormalModule.build æ–¹æ³•
build(options, compilation, resolver, fs, callback) {
  //...
  return this.doBuild(options, compilation, resolver, fs, err => {
    //...
    try {
       // è¿™é‡Œä¼šå°† source è½¬ä¸º ASTï¼Œåˆ†æå‡ºæ‰€æœ‰çš„ä¾èµ–
                const result = this.parser.parse(/*å‚æ•°*/);
                if (result !== undefined) {
                        // parse is sync
                        handleParseResult(result);
                }
        } catch (e) {
                handleParseError(e);
        }
  })
}
// NormalModule.doBuild æ–¹æ³•
doBuild(options, compilation, resolver, fs, callback) {
        //...
        // æ‰§è¡Œå„ç§ loader
        runLoaders(
                {
                        resource: this.resource,
                        loaders: this.loaders,
                        context: loaderContext,
                        readResource: fs.readFile.bind(fs)
                },
                (err, result) => {
                        //...
                        // createSource ä¼šå°† runLoader å¾—åˆ°çš„ç»“æœè½¬ä¸ºå­—ç¬¦ä¸²ä»¥ä¾¿åç»­å¤„ç†
                        this._source = this.createSource(
                                this.binary ? asBuffer(source) : asString(source),
                                resourceBuffer,
                                sourceMap
                        );
                        //...
                }
        );
}
```

åˆ›å»ºæ¨¡å—ä¹‹æ—¶ï¼Œä¼šè°ƒç”¨runLoaderså»æ‰§è¡Œloadersï¼Œä½†æ˜¯å¯¹äºloaderæ‰€åœ¨çš„ä½ç½®ï¼Œç¨‹åºè¿˜æ˜¯è¿·èŒ«çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™éœ€è¦è¯·æ±‚NormalModuleFactory.resolveRequestArrayï¼Œå¸®æˆ‘ä»¬è¯»å–loaderæ‰€åœ¨çš„åœ°å€ï¼Œæ‰§è¡Œå¹¶è¿”å›ã€‚å°±è¿™æ ·ä¸€ä¸ªä¸ªæ¨¡å—ç”Ÿæˆï¼Œä¸€ä¸ªä¸ªloaderç”Ÿæˆï¼Œç›´åˆ°æœ€åä¸€ä¸ªæ¨¡å—åˆ›å»ºå®Œæ¯•ï¼Œç„¶åå°±åˆ°äº†Compilation.sealçš„æµç¨‹äº†ã€‚

ç­‰åˆ°å½“å‰æ¨¡å—å¤„ç†å®Œloadersä¹‹åï¼Œå°†å¯¼å…¥æ¨¡å—å˜æˆæ ‡å‡†çš„JSæ¨¡å—ä¹‹åï¼Œå°±è¦å¼€å§‹åˆ†è§£æºç äº†ï¼Œè®©å®ƒå˜æˆæ ‡å‡†çš„ASTè¯­æ³•æ ‘ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦ä¾é Parserã€‚Parserå¾ˆå¼ºå¤§ï¼Œä»–å¸®åŠ©æˆ‘ä»¬å°†ä¸è§„èŒƒçš„å†…å®¹è½¬åŒ–ä¸ºæ ‡å‡†çš„æ¨¡å—ï¼Œæ–¹ä¾¿æ‰“åŒ…æ´»ç€å…¶ä»–æ“ä½œã€‚Parserç›¸å½“äºä¸€ä¸ªæœºå™¨ï¼Œæºæ–‡ä»¶è¿›å…¥ï¼Œç„¶åå¤„ç†ï¼Œç„¶åè¾“å‡ºã€‚

javascriptç±»å‹çš„Parserä¸€å…±æœ‰3ä¸ªç±»å‹ï¼Œ"auto"ã€"script"å’Œ"module"ï¼Œæ ¹æ®æ¨¡å—çš„éœ€æ±‚ï¼ŒFactoyå¸®æˆ‘ä»¬åŒ¹é…ä¸åŒç±»å‹çš„Parserã€‚
```
normalModuleFactory.hooks.createParser.for("javascript/auto").tap("JavascriptModulesPlugin", options => {
        return new Parser(options, "auto");
});
normalModuleFactory.hooks.createParser.for("javascript/dynamic").tap("JavascriptModulesPlugin", options => {
        return new Parser(options, "script");
});
normalModuleFactory.hooks.createParser.for("javascript/esm").tap("JavascriptModulesPlugin", options => {
        return new Parser(options, "module");
});
```
Parseræ˜¯æ€ä¹ˆè§£ææˆ‘ä»¬çš„æºç çš„å‘¢ï¼Ÿ

é¦–å…ˆå…ˆå˜æˆä¸€ä¸ªASTâ€”â€”æ ‡å‡†çš„è¯­æ³•æ ‘ï¼Œç»“æ„åŒ–çš„ä»£ç ï¼Œæ–¹ä¾¿åæœŸè§£æï¼Œå¦‚æœä¼ å…¥çš„sourceä¸æ˜¯astï¼Œä¹Ÿä¼šè¢«å¼ºåˆ¶astå†è¿›è¡Œå¤„ç†ã€‚
è¿™ä¸ªè§£æåº“ï¼Œwebpackç”¨çš„æ˜¯acornã€‚

8.Templateï¼ˆè¿™éƒ¨åˆ†åªæ˜¯äº†è§£äº†ä¸€ä¸‹åŸç†ï¼Œå…·ä½“æºç è¿˜æ²¡æœ‰æ·±å…¥äº†è§£ï¼‰

Templateæ˜¯åœ¨compilation.sealçš„æ—¶å€™è§¦å‘çš„ä»¬ä¹Ÿå°±æ˜¯æ¨¡å—æ„å»ºå®Œæˆä¹‹åã€‚æˆ‘ä»¬è¦å°†å¥½ä¸å®¹æ˜“æ„å»ºå®Œæˆçš„æ¨¡å—å†æ¬¡é‡ç»„æˆjsä»£ç ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨bundleä¸­è§åˆ°çš„ä»£ç ã€‚
æˆ‘ä»¬æ‰“åŒ…å‡ºæ¥çš„jsï¼Œæ€»æ˜¯ç”¨ç€ç›¸åŒçš„å¥—è·¯ï¼Ÿè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿå¾ˆæ˜æ˜¾æœ‰ä¸ªæ ‡å‡†çš„æ¨¡ç‰ˆã€‚ç­‰åˆ°æˆ‘ä»¬çš„æºæ–‡ä»¶å˜æˆastä¹‹åï¼Œå‡†å¤‡è¾“å‡ºçš„å¤„ç†éœ€è¦ä¾é Templateæ“ä½œå¦‚ä½•è¾“å‡ºï¼Œä»¥åŠwebpack-sourceå¸®åŠ©æˆ‘ä»¬åˆå¹¶æ›¿æ¢è¿˜æ˜¯astæ ¼å¼çš„æ¨¡å—ã€‚æœ€åæŒ‰ç…§chunkåˆå¹¶ä¸€èµ·è¾“å‡ºã€‚
Templateçš„ç±»ä¸€å…±æœ‰5ä¸ªï¼š

- Template.js
- MainTemplate.js
- ModuleTemplate.js
- RuntimeTemplate
- ChunkTemplate.js

å½“ç„¶ï¼æ¨¡ç‰ˆæ›¿æ¢æ˜¯åœ¨Compilationä¸­æ‰§è¡Œçš„ï¼Œæ¯•ç«ŸCompilationå°±åƒä¸€ä¸ªæŒ‡æŒ¥è€…ï¼ŒæŒ‡æŒ¥è€…å¤§å®¶å¦‚ä½•æŒ‰é¡ºåºä¸€ä¸ªä¸ªç¼–è¯‘ã€‚

Compilation.sealè§¦å‘äº†MainTemplate.getRenderManifestï¼Œè·å–éœ€è¦æ¸²æŸ“çš„ä¿¡æ¯ï¼Œæ¥ç€é€šè¿‡ä¸­çš„é’©å­è§¦å‘äº†mainTemplate.hooks.renderManifestè¿™ä¸ªé’©å­ï¼Œè°ƒç”¨äº†JavascriptModulePluginä¸­ç›¸åº”çš„å‡½æ•°ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå«æœ‰æ‰“åŒ…ä¿¡æ¯çš„fileManifestè¿”å›å¤‡ç”¨ã€‚
```
result.push({
        render: () =>
                compilation.mainTemplate.render(
                        hash,
                        chunk,
                        moduleTemplates.javascript,
                        dependencyTemplates
                ),
        filenameTemplate,
        pathOptions: {
                noChunkHash: !useChunkHash,
                contentHashType: "javascript",
                chunk
        },
        identifier: `chunk${chunk.id}`,
        hash: useChunkHash ? chunk.hash : fullHash
});
createChunkAssets(){
    //...
    const manifest = template.getRenderManifest(...)//è·å–æ¸²æŸ“åˆ—è¡¨
    //...
    for (const fileManifest of manifest) {
        //...
        source = fileManifest.render();
        //...
    }
    //...
}
```

å‡†å¤‡å·¥ä½œåšå®Œä¹‹åå°±è¦å¼€å§‹æ¸²æŸ“äº†ï¼Œè°ƒç”¨äº†fileManifestçš„renderå‡½æ•°ï¼Œå…¶å®å°±æ˜¯mainTemplate.renderã€‚mainTemplate.renderè§¦å‘äº†hooks.renderè¿™ä¸ªé’©å­ï¼Œè¿”å›äº†ä¸€ä¸ªConcatSourceçš„èµ„æºã€‚å…¶ä¸­æœ‰å›ºå®šçš„æ¨¡æ¿ï¼Œä¹Ÿæœ‰è°ƒç”¨çš„æ¨¡å—ã€‚

å„ä¸ªæ¨¡å—çš„æ¨¡æ¿æ›¿æ¢MainTemplateå°†ä»»åŠ¡åˆ†é…ç»™äº†Templateï¼Œè®©ä»–å»å¤„ç†æ¨¡å—ä»¬çš„é—®é¢˜ï¼Œäºæ˜¯è°ƒç”¨äº†Template.renderChunkModulesè¿™ä¸ªæ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•é¦–å…ˆæ˜¯è·å–æ‰€æœ‰æ¨¡å—çš„æ›¿æ¢èµ„æºã€‚

ç„¶åModuleTemplateå†å»è¯·æ±‚NormalModule.sourceè¿™ä¸ªæ–¹æ³•ã€‚è¿™é‡Œçš„moduleä¾¿ä½¿ç”¨äº†Factoryç»™ä»–é…å¤‡çš„generatorï¼Œç”Ÿæˆäº†æ›¿æ¢ä»£ç ï¼Œgenerateé˜¶æ®µçš„æ—¶å€™ä¼šè¯·æ±‚RuntimeTemplateï¼Œæ ¹æ®åå­—å¯ä»¥å¾—çŸ¥ï¼Œæ˜¯ç”¨äºæ›¿æ¢æˆè¿è¡Œæ—¶çš„ä»£ç ã€‚

ç„¶åä¸¢å…¥NormalModuleå°†æ­¤å˜ä¸ºcachedSourceï¼Œè¿”å›ç»™ModuleTemplateè¿›ä¸€æ­¥å¤„ç†ã€‚ModuleTemplateåœ¨å¯¹è¿™ä¸ªæ¨¡å—è¿›è¡Œæ‰“åŒ…ï¼Œæœ€åå‡ºæ¥çš„æ•ˆæœæ˜¯è¿™æ ·çš„ï¼š

![ModuleTemplate](/img/ModuleTemplate.png)


é©å‘½å°šæœªç»“æŸï¼æ›¿æ¢ä»åœ¨è¿›è¡Œï¼æˆ‘ä»¬å›åˆ°Template.renderChunkModulesï¼Œç»§ç»­æ›¿æ¢ã€‚
```
static renderChunkModules(chunk,filterFn,moduleTemplate,dependencyTemplates,prefix = ""){
        const source = new ConcatSource();
        const modules = chunk.getModules().filter(filterFn);
        //...å¦‚æœæ²¡æœ‰æ¨¡å—ï¼Œåˆ™è¿”å›"[]"
                source.add("[]");
                return source;
        //...å¦‚æœæœ‰æ¨¡å—åˆ™è·å–æ‰€æœ‰æ¨¡å—
        const allModules = modules.map(//...);
        //...å¼€å§‹æ·»åŠ æ¨¡å—
                source.add("[\n");
        //...
            source.add(`/* ${idx} */`);
                source.add("\n");
                source.add(module.source);
                source.add("\n" + prefix + "]");
        //...
        return source;
}

```

![concatSource](/img/concatSource.png)

æˆ‘ä»¬å°†ConcatSourceè¿”å›è‡³MainTemplate.render()ï¼Œå†åŠ ä¸ª;ï¼Œç„¶åç»„åˆè¿”å›è‡³Compliation.createChunkAssetsã€‚

åˆ°æ­¤sealä¸­templateå°±å‘Šä¸€æ®µè½å•¦ã€‚è‡³äºç”Ÿæˆæ–‡ä»¶ï¼Œé‚£å°±æ˜¯é€šè¿‡webpack-sourceè¿™ä¸ªåŒ…ï¼Œå°†æˆ‘ä»¬çš„æ•°ç»„å˜æˆå­—ç¬¦ä¸²ç„¶åæ‹¼æ¥ï¼Œæœ€åè¾“å‡ºã€‚

#### 7. æˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªå°webpack demo

[webpack demo](https://github.com/justyouhappy/my-webpack)


### åè®°
æ•´ä½“æµç¨‹ä¸‹æ¥ï¼Œå…¶å®æˆ‘ä»¬å°±å¯ä»¥æ˜ç™½ï¼Œwebpackæ˜¯ä¸€ä¸ªç”±äº‹ä»¶æµæ„æˆçš„å·¥å…·ï¼Œæ’ä»¶ä¼šåœ¨æ‰“åŒ…çš„å„ä¸ªäº‹ä»¶æµä¸­è§¦å‘ï¼Œå¹¶å¯ä»¥å¯¹å½“å‰äº‹ä»¶æµé‡Œå¯¹æ¯ä¸ªchunk(æ¯ä¸ªchunkä¸ºä¸€ä¸ªæ¨¡å—ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶)è¿›è¡Œå¤„ç†ï¼Œloaderåˆ™æ˜¯å¯¹å½“å‰loaderå¯¹åº”çš„ç‰¹å®šæ–‡ä»¶ç±»å‹ï¼ˆcss|scss|js|tsï¼‰çš„chunkåè§£æçš„è¯­æ³•æ ‘è¿›è¡Œå¤„ç†ï¼Œç”Ÿæˆæˆ‘ä»¬æƒ³è¦çš„ä½çº§è¯­æ³•ï¼Œæœ€åé€šè¿‡æ¨¡æ¿è¾“å‡ºæˆæ‰“åŒ…åçš„jsæ–‡ä»¶ã€‚